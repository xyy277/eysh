<!--#
layout("/layouts/platform.html"){
#-->
<section class="content-wrap bg-white">
<header class="header navbar bg-white shadow">
    <div class="btn-group tool-button" >
        <a class="btn btn-primary navbar-btn" href="${base}/platform/pro/flat/info/progress" id="goBack" data-pjax><i class="ti-angle-left"></i>返回</a>
    </div>
    <div class="pull-right">

    </div>
</header>
<script src="${base!}/assets/common/vendor/city-picker/js/data.86.all.js" type="text/javascript"></script>
<script src="${base!}/assets/common/vendor/city-picker/js/picker.86.js" type="text/javascript"></script>
<div class="content-wrap bg-white">
    <div class="wrapper" style="min-height:500px;top:50px;">



        <div class="col-xs-12">
            <div class="" role="tabpanel" aria-labelledby="baseInfo">
                <div class="panel-body">
                    <form id="editForm" role="form" class="form-horizontal parsley-form"  data-parsley-validate
                          action="${base}/platform/pro/flat/info/progress/editDo" method="post">
                        <input name="id" type="hidden" value="${obj.id}">
                        <input name="flat_id" type="hidden" value="${obj.flat_id}">
                        <table class="table table-bordered table-striped mg-t datatable">
                            <tbody>
                            <tr>
                                <th><span style="color: red">*</span>总完成进度(单位:%)：</th>
                                <td>
                                    <input type="text" id="finish_num" class="form-control" name="finish_num" data-parsley-required="true"
                                           placeholder="请填写总完成进度" value="${obj.finish_num}" data-parsley-min="0" data-parsley-max="100" data-parsley-type="integer">
                                </td>
                                <th><span style="color: red">*</span>完成投资额(单位:万元)：</th>
                                <td>
                                    <!--#if(!isEmpty(obj.finish_money)){
                                       #-->
                                    <input type="text" id="finish_money" class="form-control" name="f_money" data-parsley-required="true"
                                           placeholder="请填写完成投资额" value="${@money.fenToWan(obj.finish_money)}" data-parsley-price="true">
                                    <!--#
                                  } #-->
                                    <!--#if(isEmpty(obj.finish_money)){
                                    #-->
                                    <input type="text"  class="form-control" name="f_money" data-parsley-required="true"
                                           placeholder="请填写完成投资额" value="" data-parsley-price="true">
                                    <!--#
                                  } #-->
                                </td>
                            </tr>
                            <tr>
                                <th>办公场地建设投资金额(单位:万元)：</th>
                                <td>
                                    <!--#if(!isEmpty(obj.space_money)){
                                       #-->
                                    <input type="text" id="space_money" class="form-control" name="s_money"
                                           placeholder="请填写办公场地投资" value="${@money.fenToWan(obj.space_money)}" data-parsley-price="true">
                                    <!--#
                                       } #-->
                                    <!--#if(isEmpty(obj.space_money)){
                                    #-->
                                    <input type="text"  class="form-control" name="s_money"
                                           placeholder="请填写办公场地投资" value="" data-parsley-price="true">
                                    <!--#
                                       } #-->
                                </td>
                                <th>设备采购套数(单位:套)：</th>
                                <td>
                                    <input type="text" id="equipment_num" class="form-control" name="equipment_num"
                                           placeholder="请填写设备采购套数" value="${obj.equipment_num}" data-parsley-type="integer">
                                </td>
                            </tr>
                            <tr>
                                <th>办公场地建设完成面积(单位:平米)：</th>
                                <td>
                                    <input type="text" id="space_num" class="form-control" name="space_num"
                                           placeholder="请填写办公场地完成面积" value="${obj.space_num}" onkeyup="check(this)">
                                </td>
                                <th>设备采购金额(单位:万元)：</th>
                                <td>
                                    <!--#if(!isEmpty(obj.equipment_money)){
                                      #-->
                                    <input type="text" id="equipment_money" class="form-control" name="equip_money"
                                           placeholder="请填写设备采购金额" value="${@money.fenToWan(obj.equipment_money)}" data-parsley-price="true">
                                    <!--#
                                       } #-->
                                    <!--#if(isEmpty(obj.equipment_money)){
                                    #-->
                                    <input type="text" class="form-control" name="equip_money"
                                           placeholder="请填写设备采购金额" value="" data-parsley-price="true">
                                    <!--#
                                       } #-->
                                </td>
                            </tr>
                            <tr>
                                <th>软件子系统完成套数(单位:套)：</th>
                                <td>
                                    <input type="text" id="software_num" class="form-control" name="software_num"
                                           placeholder="请填写软件子系统完成套数" value="${obj.software_num}" data-parsley-type="integer">
                                </td>
                                <th>其他金额(单位:万元)：</th>
                                <td>
                                    <!--#if(!isEmpty(obj.other_money)){
                                      #-->
                                    <input type="text" id="other_money" class="form-control" name="o_money"
                                           placeholder="请填写其他金额" value="${@money.fenToWan(obj.other_money)}" data-parsley-price="true">
                                    <!--#
                                      } #-->
                                    <!--#if(isEmpty(obj.other_money)){
                                    #-->
                                    <input type="text"  class="form-control" name="o_money"
                                           placeholder="请填写其他金额" value="" data-parsley-price="true">
                                    <!--#
                                      } #-->
                                </td>
                            </tr>
                            <tr>
                                <th>软件子系统对应金额(单位:万元)：</th>
                                <td>
                                    <!--#if(!isEmpty(obj.software_money)){
                                      #-->
                                    <input type="text" id="software_money" class="form-control" name="soft_money"
                                           placeholder="请填写软件子系统对应金额" value="${@money.fenToWan(obj.software_money)}" data-parsley-price="true">
                                    <!--#
                                       } #-->
                                    <!--#if(isEmpty(obj.software_money)){
                                    #-->
                                    <input type="text"  class="form-control" name="soft_money"
                                           placeholder="请填写软件子系统对应金额" value="" data-parsley-price="true">
                                    <!--#
                                       } #-->
                                </td>
                                <th><span style="color: red">*</span>报送人:</th>
                                <td>
                                    <input type="text" id="send_person" class="form-control" name="send_person"
                                           placeholder="请填写报送人" value="${obj.send_person}" data-parsley-required="true" data-parsley-maxlength="32">
                                </td>
                            </tr>
                            <tr>
                                <th><span style="color: red">*</span>报送日期：</th>
                                <td>
                                    <input type="hidden" name="sendDate"  value="${obj.sendDate}" />
                                    <input type="text" id="sendDate" placeholder="请填写报送年月" class="form-control js-time"   value="${obj.sendDate}" data-toggle="modal" data-target="#dialogSelectClass" disabled="disabled"/>
                                </td>
                                <th><span style="color: red">*</span>报送人手机号：</th>
                                <td>
                                    <input type="text" id="sendTel" class="form-control" name="sendTel"
                                           placeholder="请填写报送人手机号" value="${obj.sendTel}" data-parsley-required="true"  data-parsley-pattern="0?(13|14|15|17|18)[0-9]{9}" >
                                </td>
                            </tr>
                            <tr>
                                <th>待协调解决的问题:</th>
                                <td colspan="3">
                                    <textarea id="unsolved" name="unsolved" style="width:550px;height:60px;">${obj.unsolved}</textarea>
                                </td>
                            </tr>
                            <tr>
                                <th>附件:</th>
                                <td colspan="3">
                                    <div id="attachment_queue"></div>
                                    <div>
                                        <input id="attachment_file_upload" name="attachment_file_upload" type="file" multiple="false">
                                    </div>
                                    <div id="attachment_display" style="padding: 5px;">
                                        <!--# if (!isEmpty(files)){
                                          var i = 0;
                                          for(f in files){
                                              i++;
                                              var c = "divFile";
                                                if(i == 1){
                                                   c = "divFileD";
                                               }
                                      #-->
                                        <div id='attachment_${i}' class='${c}'>
                                            <a  style="text-decoration:underline;color:blue;" href="${f.url}">${f.name}</a>
                                            <i style='float: right;padding-top: 4px;' class='fa fa-close' onclick="delFileAlbumImg('attachment_${i}')"></i>
                                        </div>
                                        <!--#}}#-->
                                    </div>
                                    <input type="hidden" id="attachment" name="attachment" value="" >
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="col-lg-3"></div>
                        <div class="col-lg-6">
                            <div class="form-group text-center">
                                <div>
                                    <button class="btn btn-primary" data-loading-text="正在提交..." type="button" onclick="postData();">提 交</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</section>
<script language="JavaScript">
    var uploadFileList = [];
    $(document).ready(function () {

        var files = "${obj.attachment}";
        if(files){
            var fileList = files.split(",");
            for(var i=0;i<fileList.length;i++){
                if(fileList[i])uploadFileList.push(fileList[i]);
            }
        }

        /*时间选择控件*/
        $('.js-time').datetimepicker({
            language:  'zh-CN',  //日期
            format: 'yyyy-mm',
            minView:"month",
            weekStart: 1,
            todayBtn: true,
            autoclose: true,
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            showMeridian: 1
        });

        $('#attachment_file_upload').uploadifive(initFileAlbumOptions('attachment_queue','fileItem','attachment_display'));


        $('#editForm').ajaxForm({
            dataType: 'json',
            beforeSubmit: function (arr, form, options) {

                var attachment = {
                    name : "attachment",
                    required: false
                }
                if(uploadFileList.length > 0){
                    attachment.value = uploadFileList;
                }else{
                    attachment.value = "";
                }
                arr.push(attachment);
                form.find("button:submit").button("loading");
            },
            success: function (data, statusText, xhr, form) {
                if (data.code == 0) {
                    Toast.success(data.msg);
                    window.location.href=$("#goBack").attr("href");
                } else {
                    Toast.error(data.msg);
                }
                form.find("button:submit").button("reset");
            }
        });
    });

    function postData() {

        var mo="${@money.fenToWan(mmoney)}";
        var c_mo=parseFloat(mo);//投资额

        var mn="${mnum}";
        var c_mn = parseInt(mn);//进度

        var money=$("#finish_money").val();
        var c_money = parseInt(money);//填写金额

        var num=$("#finish_num").val();
        var c_nu = parseInt(num);//填写进度

        if(c_money==c_mo){
            $('#editForm').submit();
        }
        if(c_money<c_mo){
            Toast.error("请填写大于上次报送的完成投资额");
            return false;
        }
        if(c_nu==c_mn){
            $('#editForm').submit();
        }
        if(c_nu<c_mn){
            Toast.error("请填写大于上次报送的总完成进度");
            return false;
        }
        $('#editForm').submit();
    }

    function check(obj) {
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符

        obj.value = obj.value.replace(/^\./g,"");  //验证第一个字符是数字而不是.

        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.

        obj.value = obj.value.replace(/([0-9]+.[0-9]{2})[0-9]*/,"$1");//最高保留小数点后两位

        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");

    }

    /**
     * 初始化文件集方法
     * @param queueId 队列元素ID
     * @param fileuploadId 上传容器ID
     * @param imgDivIdPrefix 图片DIV的名称前缀
     * @param albumContainer 相册图容器Id
     */
    function initFileAlbumOptions(queueId,imgDivIdPrefix,albumContainerId) {
        var albumContainer = document.getElementById(albumContainerId);
        var sort = Sortable.create(albumContainer);
        var fileIndex = $(albumContainer).children().size();
        return {
            'auto': true,
            'multi': true,
            'width': '100%',
            'height': '35',
            'buttonText': '请选择文件',
            'fileType':'*',
            'fileSizeLimit': 5242870,
            'queueSizeLimit': 5,
            'formData': {},
            'queueID': queueId,
            'removeCompleted':true,
            'removeTimeout':0,
            'uploadScript': '${base!}/open/file/upload/file?u=0',
            'onUploadComplete': function (file, data) {
                data = JSON.parse(data);
                if (data.code == 0) {
                    uploadFileList.push(data.data.id);
                    Toast.success(data.msg);
                    var c = "divFile";
                    fileIndex++;
                    if(fileIndex == 1){
                        c = "divFileD";
                    }
                    var imgDivId = imgDivIdPrefix + fileIndex;
                    $(albumContainer).append("<div id='"+imgDivId+"' class='"+c+"'>" +
                        "<a  href=\""+data.data.url+"\">" + data.data.name+ "</a>" +
                        "<i style='float: right;padding-top: 4px;' class='fa fa-close' onclick=\"delFileAlbumImg('"+imgDivId+"')\"></i></div>");
                    sort.destroy();
                    sort = Sortable.create(albumContainer);
                    $("#"+queueId).empty();
                } else {
                    Toast.error(data.msg);
                }
            }
        };
    }

    /*添加文件*/
    function setFileAlbumImg(id){
        $("#"+id).removeClass("divFile").addClass("divFileD").siblings().removeClass("divFileD").addClass("divFile");
    }
    /*删除文件*/
    function delFileAlbumImg(id){
        var data = $(this).prev('img').attr("src");
        uploadFileList.splice(getFileImageListIndex(data),1);
        $("#"+id).remove();
    }

    //获取上传文件的索引下标
    function  getFileImageListIndex(val) {
        for(var i=0;i<uploadFileList.length;i++){
            if(uploadFileList[i] == val){
                return i;
            }
        }
    }
</script>
<!--#}#-->