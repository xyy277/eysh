<!--#
layout("/layouts/platform.html"){
#-->
<script src="${base!}/assets/platform/vendor/ueditor/ueditor.config.js"></script>
<script src="${base!}/assets/platform/vendor/ueditor/ueditor.all.js"></script>
<header class="header navbar bg-white shadow">
    <div class="btn-group tool-button">
        <a class="btn btn-primary navbar-btn" href="${base}/platform/pro/flat/info" id="goBack" data-pjax><i class="ti-angle-left"></i>${msg['globals.button.back']}</a>
    </div>
</header>

<div class="content-wrap">
    <div class="wrapper" style="min-height:500px;">
        <section class="panel panel-form">
            <form id="addForm" role="form" class="form-horizontal parsley-form" data-parsley-validate
                  action="${base}/platform/pro/flat/info/addDo" method="post">
                <div class="row mb10">
                    <div class="col-lg-12">
                        <!--<div class="form-group">
                            <label for="unitId" class="col-sm-2 control-label">所属单位</label>
                            <div class="col-sm-8">
                            <input type="text" id="unitId" class="form-control" name="unitId" data-parsley-required="true" placeholder="所属单位">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="flat_id" class="col-sm-2 control-label">平台编码</label>
                            <div class="col-sm-8">
                            <input type="text" id="flat_id" class="form-control" name="flat_id" data-parsley-required="true" placeholder="平台编码">
                            </div>
                        </div>-->
                        <div class="form-group">
                            <label for="flat_type" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>平台类型</label>
                            <div class="col-sm-3">
                                <select id="flat_type"  class="form-control" name="flat_type" >
                                    <!--# for(p in platforms){#-->
                                    <option value="${p.code}">${p.name}</option>
                                    <!--#}#-->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="flat_name" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>服务平台名称</label>
                            <div class="col-sm-8">
                            <input type="text" id="flat_name" class="form-control" name="flat_name" data-parsley-required="true" placeholder="服务平台名称" maxlength="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="org_property" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>主体单位性质</label>
                            <div class="col-sm-3">
                                <select id="org_property"  class="form-control" name="org_property" data-parsley-required="true" >
                                    <!--# for(p in orgs){#-->
                                    <option value="${p.code}">${p.name}</option>
                                    <!--#}#-->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="org_code" class="col-sm-2 control-label">组织机构代码</label>
                            <div class="col-sm-8">
                            <input type="text" id="org_code" class="form-control" name="org_code" placeholder="组织机构代码"  maxlength="18">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="org_name" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>主体机构名称</label>
                            <div class="col-sm-8">
                            <input type="text" id="org_name" class="form-control" name="org_name" data-parsley-required="true" placeholder="主体机构名称" maxlength="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="legal_person" class="col-sm-2 control-label">主体法定代表人</label>
                            <div class="col-sm-8">
                            <input type="text" id="legal_person" class="form-control" name="legal_person" placeholder="主体法定代表人" maxlength="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="area_county" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>所在区县</label>
                            <div class="col-sm-3">
                                <select id="area_county"  class="form-control" name="area_county"  >
                                    <!--# for(p in areas){#-->
                                    <option value="${p.code}">${p.name}</option>
                                    <!--#}#-->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="linkman" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>联系人</label>
                            <div class="col-sm-8">
                            <input type="text" id="linkman" class="form-control" name="linkman" data-parsley-required="true" placeholder="联系人" maxlength="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tel" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>手机号码</label>
                            <div class="col-sm-8">
                            <input type="text" id="tel" class="form-control" name="tel" data-parsley-required="true" placeholder="手机号码"  data-parsley-pattern="0?(13|14|15|17|18)[0-9]{9}" >
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fax" class="col-sm-2 control-label">传真</label>
                            <div class="col-sm-8">
                            <input type="text" id="fax" class="form-control" name="fax" placeholder="传真" maxlength="40">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email" class="col-sm-2 control-label">电子邮箱</label>
                            <div class="col-sm-8">
                            <input type="text" id="email" class="form-control" name="email" placeholder="电子邮箱" data-parsley-type="email" maxlength="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="website" class="col-sm-2 control-label">网址</label>
                            <div class="col-sm-8">
                            <input type="text" id="website" class="form-control" name="website" placeholder="网址" maxlength="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address" class="col-sm-2 control-label">通讯地址</label>
                            <div class="col-sm-8">
                                <input readonly type="text" data-toggle="city-picker" class="form-control"
                                       value="" name="total_address"
                                       data-parsley-required="false" id="totalAddress">

                            </div>
                        </div>
                        <div class="form-group">
                            <label for="postcode" class="col-sm-2 control-label">详细地址</label>
                            <div class="col-sm-8">
                                <input type="text" id="address" value="" name="address" class="form-control"
                                       placeholder="请填写详细的通讯地址" maxlength="500"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="postcode" class="col-sm-2 control-label">邮政编码</label>
                            <div class="col-sm-8">
                            <input type="text" id="postcode" class="form-control" name="postcode" placeholder="邮政编码" data-parsley-type="number" minlength="6" maxlength="6">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="build_start" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>建设开始日期</label>
                            <div class="col-sm-3">
                                <input type="text" id="build_start" readonly name="build_start" class="js-time form-control" data-parsley-required="true" placeholder="建设周期起">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="build_start" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>建设结束日期</label>
                            <div class="col-sm-3">
                                <input type="text" id="build_end" readonly name="build_end" class="js-time form-control" data-parsley-required="true" placeholder="建设周期止">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="total_money" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>总投资(万元)</label>
                            <div class="col-sm-3">
                                <input type="text" id="total_money" name="total_money_" data-parsley-required="true" class="form-control" data-parsley-price="true"  maxlength="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="total_money" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>自筹资金(万元)</label>
                            <div class="col-sm-3">
                                <input type="text" id="self_money" name="self_money_" data-parsley-required="true" class="form-control" data-parsley-price="true"  maxlength="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="total_money" class="col-sm-2 control-label"><span style="color: rgb(255, 0, 0);">*</span>政策补助资金(万元)</label>
                            <div class="col-sm-3">
                                <input type="text" id="gov_money" name="gov_money_" data-parsley-required="true" class="form-control" data-parsley-price="true" maxlength="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="space_note" class="col-sm-2 control-label">办公场地</label>
                            <div class="col-sm-8">
                                <input type="radio" name="space_has" value="1" checked />有 <input type="radio" name="space_has" value="0" />无
                                <textarea id="space_note" maxlength="100"  name="space_note" data-parsley-required="true"  placeholder="简述办公场地建设规划" class="form-control"  maxlength="500"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="equipment_note" class="col-sm-2 control-label">设备采购</label>
                            <div class="col-sm-8">
                                <input type="radio" name="equipment_has" value="1" checked />有 <input type="radio" name="equipment_has" value="0" />无
                                <textarea id="equipment_note" maxlength="100"  name="equipment_note" data-parsley-required="true" placeholder="设备采购说明" class="form-control"  maxlength="500"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="informatization_note" class="col-sm-2 control-label">信息化说明</label>
                            <div class="col-sm-8">
                                <input type="radio" name="informatization_has" value="1" checked />有 <input type="radio" name="informatization_has" value="0" />无
                                <textarea id="informatization_note"  name="informatization_note" data-parsley-required="true" placeholder="信息化说明" class="form-control" maxlength="500"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="main_remark" class="col-sm-2 control-label">平台介绍</label>
                            <div class="col-sm-8">
                                <textarea id="main_remark" data-parsley-maxlength="4000"  type="text/plain" style="width:800px;height:300px;" ></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">附件</label>
                            <div class="col-sm-8">
                                <div id="attachment_queue"></div>
                                <div>
                                    <input id="attachment_file_upload" name="attachment_file_upload" type="file" multiple="false">
                                </div>
                                <div id="attachment_display" style="padding: 5px;">
                                </div>
                                <input type="hidden" id="attachment" name="attachment" value="" >
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3"></div>
                <div class="col-lg-6">
                    <div class="form-group text-center">
                        <label></label>
                        <div>
                            <button class="btn btn-primary btn-block btn-lg btn-parsley" id="submit_button"  onclick="submitForm();" type="button"  data-loading-text="正在提交...">提 交</button>
                        </div>
                    </div>
                </div>
            </form>
        </section>
    </div>
</div>
<script language="JavaScript">
    var uploadFileList = [];
    $(function () {
        setTimeout(function () {
            var ue = new baidu.editor.ui.Editor();
            ue.render('main_remark');
        },1000);


        //初始化城市选择器
        var totalAddress = $('#totalAddress');
        totalAddress.citypicker();

        $(":radio").on("click",function(){
            var name = $(this).attr("name");
            name = name.substr(0,name.length-3)+"note";
            if($(this).val()==1){
                $("#"+name).attr("data-parsley-required",true);
                $("#"+name).attr("disabled",false);
            }else{
                $("#"+name).attr("data-parsley-required",false);
                $("#"+name).attr("disabled",true);
            }
        });

        /*时间选择控件*/
        $('#build_start').datetimepicker({
            minView: "month",
            format: "yyyy-mm-dd", //选择日期后，文本框显示的日期格式
            language: 'zh-CN', //汉化
            autoclose: true, //选择日期后自动关闭
        }).on('changeDate', function (e) {
            var startTime = e.date;
            $('#build_end').datetimepicker('setStartDate', startTime);
        });
        //结束时间：
        $('#build_end').datetimepicker({
            minView: "month",
            format: "yyyy-mm-dd", //选择日期后，文本框显示的日期格式
            language: 'zh-CN', //汉化
            autoclose: true, //选择日期后自动关闭
        }).on('changeDate', function (e) {
            var endTime = e.date;
            $('#build_start').datetimepicker('setEndDate', endTime);
        });

        $('#attachment_file_upload').uploadifive(initFileAlbumOptions('attachment_queue','fileItem','attachment_display'));

        $('#addForm').ajaxForm({
            dataType: 'json',
            beforeSubmit: function (arr, form, options) {
                var province = { name : "province",value:'' };
                var city = { name : "city",value:'' };
                var area = { name : "area" ,value:''};
                $(".select-item").each(function(){
                    var count = $(this).attr("data-count");
                    if(count=="province"){
                        province.value = $(this).attr("data-code");
                    }else if(count=="city"){
                        city.value = $(this).attr("data-code");
                    }else if(count=="county"){
                        area.value = $(this).attr("data-code");
                    }
                });

                var main_remark = {
                    name : "main_remark",
                    required: false
                }
                main_remark.value=UE.getEditor('main_remark').getContent();

                var attachment = {
                    name : "attachment",
                    required: false
                }
                if(uploadFileList.length > 0){
                    /*var data = JSON.stringify(uploadFileList);*/
                    attachment.value = uploadFileList;
                }else{
                    attachment.value = "";
                }
                arr.push(attachment);

                arr.push(province);
                arr.push(city);
                arr.push(area);
                arr.push(main_remark);

                form.find("#submit_button").button("loading");
            },
            success: function (data, statusText, xhr, form) {
                if (data.code == 0) {
                    Toast.success(data.msg);
                    setTimeout(function () {
                        window.location.href="${base}/platform/pro/flat/info";
                    }, 1000);
                } else {
                    Toast.error(data.msg);
                }
                form.find("#submit_button").button("reset");
            }
        });
    });
    function submitForm() {
        var total_money = $("#total_money").val();
        var self_money = $("#self_money").val();
        var gov_money = $("#gov_money").val();
        if (total_money != "" && self_money != "" && gov_money != "") {
            total_money = parseFloat(total_money);
            self_money = parseFloat(self_money);
            gov_money = parseFloat(gov_money);
            if (total_money != accAdd(self_money, gov_money)) {
                $("#total_money").focus();
                Toast.error("总金额必须为自筹资金与政策补助资金的和");
                return;
            }
        }
        $('#addForm').submit();
    }

    function accAdd(arg1, arg2) {
        var r1, r2, m;
        try {
            r1 = arg1.toString().split(".")[1].length
        } catch (e) {
            r1 = 0
        }
        try {
            r2 = arg2.toString().split(".")[1].length
        } catch (e) {
            r2 = 0
        }
        m = Math.pow(10, Math.max(r1, r2))
        return (arg1 * m + arg2 * m) / m
    }
    /**
     * 初始化文件集方法
     * @param queueId 队列元素ID
     * @param fileuploadId 上传容器ID
     * @param imgDivIdPrefix 图片DIV的名称前缀
     * @param albumContainer 相册图容器Id
     */
    function initFileAlbumOptions(queueId, imgDivIdPrefix, albumContainerId) {
        var albumContainer = document.getElementById(albumContainerId);
        var sort = Sortable.create(albumContainer);
        var fileIndex = $(albumContainer).children().size();
        return {
            'auto': true,
            'multi': true,
            'width': '100%',
            'height': '35',
            'buttonText': '请选择文件',
            'fileType': '*',
            'fileSizeLimit': 5242870,
            'queueSizeLimit': 5,
            'formData': {},
            'queueID': queueId,
            'removeCompleted': true,
            'removeTimeout': 0,
            'uploadScript': '${base!}/open/file/upload/file?u=0&fs=fs',
            'onUploadComplete': function (file, data) {
                data = JSON.parse(data);
                if (data.code == 0) {
                    uploadFileList.push(data.data.id);
                    Toast.success(data.msg);
                    var c = "divFile";
                    fileIndex++;
                    if (fileIndex == 1) {
                        c = "divFileD";
                    }
                    var imgDivId = imgDivIdPrefix + fileIndex;
                    $(albumContainer).append("<div id='" + imgDivId + "' class='" + c + "'>" +
                        "<a  href=\"" + data.data.url + "\">" + data.data.name + "</a>" +
                        "<i style='float: right;padding-top: 4px;' class='fa fa-close' onclick=\"delFileAlbumImg('" + imgDivId + "')\"></i></div>");
                    sort.destroy();
                    sort = Sortable.create(albumContainer);
                    $("#" + queueId).empty();
                } else {
                    Toast.error(data.msg);
                }
            }
        };
    }

    /*添加文件*/
    function setFileAlbumImg(id) {
        $("#" + id).removeClass("divFile").addClass("divFileD").siblings().removeClass("divFileD").addClass("divFile");
    }
    /*删除文件*/
    function delFileAlbumImg(id) {
        var data = $(this).prev('img').attr("src");
        uploadFileList.splice(getFileImageListIndex(data), 1);
        $("#" + id).remove();
    }

    //获取上传文件的索引下标
    function getFileImageListIndex(val) {
        for (var i = 0; i < uploadFileList.length; i++) {
            if (uploadFileList[i] == val) {
                return i;
            }
        }
    }


</script>
<!--#}#-->
