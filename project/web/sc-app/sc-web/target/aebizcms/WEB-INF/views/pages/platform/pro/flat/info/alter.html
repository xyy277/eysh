<!--#
layout("/layouts/platform.html"){
#-->
<script src="${base!}/assets/platform/vendor/ueditor/ueditor.config.js"></script>
<script src="${base!}/assets/platform/vendor/ueditor/ueditor.all.js"></script>
<header class="header navbar bg-white shadow">
    <div class="btn-group tool-button">
        <a class="btn btn-primary navbar-btn" href="${base}/platform/pro/flat/info" id="goBack" data-pjax><i
                class="ti-angle-left"></i>${msg['globals.button.back']}</a>
    </div>
</header>

<div class="content-wrap">
    <div class="wrapper" style="min-height:500px;">
        <section class="panel panel-form">
            <form id="addForm" role="form" class="form-horizontal parsley-form" data-parsley-validate
                  action="${base}/platform/pro/flat/info/alterDo" method="post">
                <input type="hidden" name="id" value="${obj.id!}">
                <div class="row mb10">
                    <div class="col-lg-12">
                        <!--<div class="form-group">
                            <label for="unitId" class="col-sm-2 control-label">所属单位</label>
                            <div class="col-sm-8">
                            <input type="text" id="unitId" class="form-control" name="unitId" data-parsley-required="true" placeholder="所属单位">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="flat_id" class="col-sm-2 control-label">平台编码</label>
                            <div class="col-sm-8">
                            <input type="text" id="flat_id" class="form-control" name="flat_id" data-parsley-required="true" placeholder="平台编码">
                            </div>
                        </div>-->
                        <div class="form-group">
                            <label for="flat_type" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>平台类型</label>
                            <div class="col-sm-3">
                                <select id="flat_type" class="form-control" name="flat_type">
                                    <!--# for(p in platforms){#-->
                                    <option value="${p.id}" <!--# if(obj.flat_type==p.id){#--> selected="selected"
                                    <!--#}#-->>${p.name}</option>
                                    <!--#}#-->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="flat_name" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>服务平台名称</label>
                            <div class="col-sm-8">
                                <input type="text" id="flat_name" value="${obj.flat_name}" class="form-control"
                                       name="flat_name" data-parsley-required="true" placeholder="服务平台名称" data-parsley-maxlength="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="org_property" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>主体单位性质</label>
                            <div class="col-sm-3">
                                <select id="org_property" class="form-control" name="org_property"
                                        data-parsley-required="true">
                                    <!--# for(p in orgs){#-->
                                    <option value="${p.id}" <!--# if(obj.org_property==p.id){#--> selected="selected"
                                    <!--#}#-->>${p.name}</option>
                                    <!--#}#-->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="org_code" class="col-sm-2 control-label">组织机构代码</label>
                            <div class="col-sm-8">
                                <input type="text" id="org_code" value="${obj.org_code}" class="form-control"
                                       name="org_code" placeholder="组织机构代码"  data-parsley-maxlength="18">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="org_name" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>主体机构名称</label>
                            <div class="col-sm-8">
                                <input type="text" id="org_name" value="${obj.org_name}" class="form-control"
                                       name="org_name" data-parsley-required="true" placeholder="主体机构名称" data-parsley-maxlength="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="legal_person" class="col-sm-2 control-label">主体法定代表人</label>
                            <div class="col-sm-8">
                                <input type="text" id="legal_person" value="${obj.legal_person}" class="form-control"
                                       name="legal_person" placeholder="主体法定代表人"  data-parsley-maxlength="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="area_county" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>所在区县</label>
                            <div class="col-sm-3">
                                <select id="area_county" class="form-control" name="area_county">
                                    <!--# for(p in areas){#-->
                                    <option value="${p.code}"<!--# if(obj.area_county==p.code){#--> selected="selected"
                                    <!--#}#-->>${p.name}</option>
                                    <!--#}#-->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="linkman" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>联系人</label>
                            <div class="col-sm-8">
                                <input type="text" id="linkman" value="${obj.linkman}" class="form-control"
                                       name="linkman" data-parsley-required="true" placeholder="联系人" data-parsley-maxlength="20">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tel" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>手机号码</label>
                            <div class="col-sm-8">
                                <input type="text" id="tel" value="${obj.tel}" class="form-control" name="tel"
                                       data-parsley-required="true" placeholder="手机号码" data-parsley-pattern="0?(13|14|15|17|18)[0-9]{9}" >
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fax" class="col-sm-2 control-label">传真</label>
                            <div class="col-sm-8">
                                <input type="text" id="fax" value="${obj.fax}" class="form-control" name="fax"
                                       placeholder="传真"  data-parsley-maxlength="40">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email" class="col-sm-2 control-label">电子邮箱</label>
                            <div class="col-sm-8">
                                <input type="text" id="email" value="${obj.email}" class="form-control" name="email"
                                       placeholder="电子邮箱" data-parsley-type="email" data-parsley-maxlength="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="website" class="col-sm-2 control-label">网址</label>
                            <div class="col-sm-8">
                                <input type="text" id="website" value="${obj.website}" class="form-control"
                                       name="website" placeholder="网址" data-parsley-maxlength="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address" class="col-sm-2 control-label">通讯地址</label>
                            <div class="col-sm-8">
                                <input readonly type="text" data-toggle="city-picker" class="form-control"
                                       value="${obj.province}/${obj.city}/${obj.area}" name="total_address"
                                       data-parsley-required="false" id="totalAddress">

                                <!--<input type="text" id="address" class="form-control" name="address" data-parsley-required="true" placeholder="通讯地址">-->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="postcode" class="col-sm-2 control-label">详细地址</label>
                            <div class="col-sm-8">
                                <input type="text" id="address" value="${obj.address}" name="address" class="form-control"
                                       placeholder="请填写详细的通讯地址" data-parsley-maxlength="500"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="postcode" class="col-sm-2 control-label">邮政编码</label>
                            <div class="col-sm-8">
                                <input type="text" id="postcode" value="${obj.postcode}" class="form-control"
                                       name="postcode" placeholder="邮政编码" data-parsley-type="number" minlength="6"
                                       maxlength="6">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="build_start" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>建设开始日期</label>
                            <div class="col-sm-3">
                                <input type="text" id="build_start" readonly value="${obj.build_start}"
                                       name="build_start" class="js-time form-control" data-parsley-required="true"
                                       placeholder="建设周期起">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="build_start" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>建设结束日期</label>
                            <div class="col-sm-3">
                                <input type="text" id="build_end" readonly value="${obj.build_end}" name="build_end"
                                       class="js-time form-control" data-parsley-required="true" placeholder="建设周期止">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="total_money" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>总投资(万元)</label>
                            <div class="col-sm-3">
                                <input type="text" id="total_money" name="total_money_" class="form-control"  data-parsley-maxlength="20"
                                          value="${@money.fenToWan(obj.total_money)}" data-parsley-required="true"
                                          data-parsley-price="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="total_money" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>自筹资金(万元)</label>
                            <div class="col-sm-3">
                                <input type="text" id="self_money" name="self_money_" class="form-control"  data-parsley-maxlength="20"
                                           value="${@money.fenToWan(obj.self_money)}" data-parsley-required="true"
                                           data-parsley-price="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="total_money" class="col-sm-2 control-label"><span
                                    style="color: rgb(255, 0, 0);">*</span>政策补助资金(万元)</label>
                            <div class="col-sm-3">
                                <input type="text" id="gov_money" name="gov_money_" class="form-control"  data-parsley-maxlength="20"
                                             value="${@money.fenToWan(obj.gov_money)}" data-parsley-required="true"
                                             data-parsley-price="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="space_note" class="col-sm-2 control-label">办公场地</label>
                            <div class="col-sm-3">
                                <input type="radio" name="space_has" value="1"  <!--# if(obj.space_has==1){#--> checked
                                <!--#}#--> />有 <input type="radio" name="space_has" value="0"
                                <!--# if(obj.space_has==0){#--> checked <!--#}#--> />无
                                <textarea type="text" id="space_note"  name="space_note" class="form-control"
                                       placeholder="办公场地建设规划" <!--# if(obj.space_has==1){#--> data-parsley-required="true"  <!--#}#-->   data-parsley-maxlength="500"
                                <!--# if(obj.space_has==0){#--> disabled <!--#}#-->  >${obj.space_note}</textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="equipment_note" class="col-sm-2 control-label">设备采购</label>
                            <div class="col-sm-3">
                                <input type="radio" name="equipment_has" value="1"  <!--# if(obj.equipment_has==1){#-->
                                checked <!--#}#--> />有 <input type="radio" name="equipment_has" value="0"
                                <!--# if(obj.equipment_has==0){#--> checked <!--#}#--> />无
                                <textarea type="text" id="equipment_note" class="form-control"
                                       name="equipment_note" placeholder="设备采购说明" <!--# if(obj.equipment_has==1){#--> data-parsley-required="true"<!--#}#-->  data-parsley-maxlength="500"
                                <!--# if(obj.equipment_has==0){#--> disabled <!--#}#--> >${obj.equipment_note}</textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="informatization_note" class="col-sm-2 control-label">信息化说明</label>
                            <div class="col-sm-3">
                                <input type="radio" name="informatization_has" value="1"
                                <!--# if(obj.informatization_has==1){#--> checked <!--#}#--> />有 <input type="radio"
                                                                                                        name="informatization_has"
                                                                                                        value="0"
                                <!--# if(obj.informatization_has==0){#--> checked <!--#}#--> />无
                                <textarea type="text" id="informatization_note"  class="form-control"
                                       name="informatization_note" placeholder="信息化说明"  data-parsley-maxlength="500"  <!--# if(obj.informatization_has==1){#--> data-parsley-required="true"<!--#}#-->
                                <!--# if(obj.informatization_has==0){#--> disabled <!--#}#--> >${obj.informatization_note}</textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="main_remark" class="col-sm-2 control-label">平台介绍</label>
                            <div class="col-sm-8">
                                <textarea id="main_remark" data-parsley-maxlength="4000"  type="text/plain" style="width:800px;height:300px;" >${obj.main_remark}</textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">附件</label>
                            <div class="col-sm-8">
                                <div id="attachment_display" style="padding: 5px;">
                                    <!--# if (!isEmpty(files)){
                                      var i = 0;
                                      for(f in files){
                                          i++;
                                          var c = "divFile";
                                            if(i == 1){
                                               c = "divFileD";
                                           }
                                  #-->
                                    <div id='attachment_${i}' class='${c}'>
                                        <a href="${f.url}" style="text-decoration:underline;color:blue;">${f.name}</a>
                                    </div>
                                    <!--#}}#-->
                                </div>
                                <input type="hidden" id="attachment" name="attachment" value="">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3"></div>
                <div class="col-lg-6">
                    <div class="form-group text-center">
                        <label></label>
                        <div>
                            <button class="btn btn-primary btn-block btn-lg btn-parsley" id="submit_button" onclick="submitForm();" type="button" data-loading-text="正在提交...">提
                                交
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </section>
    </div>
</div>
<script language="JavaScript">
    function load_uedit() {
        var ue = new baidu.editor.ui.Editor();
        ue.render('main_remark');
    }
    $(function () {
        setTimeout(load_uedit, 1000);

        //初始化城市选择器
        var totalAddress = $('#totalAddress');
        totalAddress.citypicker();


        $(":radio").on("click",function(){
            var name = $(this).attr("name");
            name = name.substr(0,name.length-3)+"note";
            if($(this).val()==1){
                $("#"+name).attr("data-parsley-required",true);
                $("#"+name).attr("disabled",false);
            }else{
                $("#"+name).attr("data-parsley-required",false);
                $("#"+name).attr("disabled",true);
            }
        });

        /*时间选择控件*/
        $('#build_start').datetimepicker({
            minView: "month",
            format: "yyyy-mm-dd", //选择日期后，文本框显示的日期格式
            language: 'zh-CN', //汉化
            autoclose: true, //选择日期后自动关闭
        }).on('changeDate', function (e) {
            var startTime = e.date;
            $('#build_end').datetimepicker('setStartDate', startTime);
        });
        //结束时间：
        $('#build_end').datetimepicker({
            minView: "month",
            format: "yyyy-mm-dd", //选择日期后，文本框显示的日期格式
            language: 'zh-CN', //汉化
            autoclose: true, //选择日期后自动关闭
        }).on('changeDate', function (e) {
            var endTime = e.date;
            $('#build_start').datetimepicker('setEndDate', endTime);
        });

        $('#addForm').ajaxForm({
            dataType: 'json',
            beforeSubmit: function (arr, form, options) {
                var province = {name: "province", value: ''};
                var city = {name: "city", value: ''};
                var area = {name: "area", value: ''};
                $(".select-item").each(function () {
                    var count = $(this).attr("data-count");
                    if (count == "province") {
                        province.value = $(this).attr("data-code");
                    } else if (count == "city") {
                        city.value = $(this).attr("data-code");
                    } else if (count == "county") {
                        area.value = $(this).attr("data-code");
                    }
                });

                var main_remark = {
                    name: "main_remark",
                    required: false
                }
                main_remark.value = UE.getEditor('main_remark').getContent();

                arr.push(province);
                arr.push(city);
                arr.push(area);
                arr.push(main_remark);

                form.find("#submit_button").button("loading");
            },
            success: function (data, statusText, xhr, form) {
                if (data.code == 0) {
                    Toast.success(data.msg);
                    setTimeout(function () {
                        window.location.href = "${base}/platform/pro/flat/info";
                    }, 1000);
                } else {
                    Toast.error(data.msg);
                }
            }
        });
    });

    function submitForm() {
        var total_money = $("#total_money").val();
        var self_money = $("#self_money").val();
        var gov_money = $("#gov_money").val();
        if(total_money!=""&&self_money!=""&&gov_money!=""){
            total_money = parseFloat(total_money);
            self_money = parseFloat(self_money);
            gov_money = parseFloat(gov_money);
            if(total_money!=accAdd(self_money,gov_money)){
                $("#total_money").focus();
                Toast.error("总金额必须为自筹资金与政策补助资金的和");
                return;
            }
        }
        $('#addForm').submit();
    }

    function accAdd(arg1,arg2){
        var r1,r2,m;
        try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
        try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
        m=Math.pow(10,Math.max(r1,r2))
        return (arg1*m+arg2*m)/m
    }

</script>
<!--#}#-->


